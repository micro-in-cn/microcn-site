(window.webpackJsonp=window.webpackJsonp||[]).push([[221],{3215:function(n,s){n.exports={content:["article",["p","这里主要和大家演示如何使用 go-micro。"],["p","如果想先从更高的角度了解相关的工具集，可以查看博客",["a",{title:null,href:"https://micro.mu/blog/2016/03/20/micro.html"},"https://micro.mu/blog/2016/03/20/micro.html"],"。"],["h2","编写服务"],["p","顶级的服务接口",["a",{title:null,href:"https://pkg.go.dev/github.com/micro/go-micro/v2#Service"},"Service"],"，是构建服务所需的主要组件。它把所有 Go-Micror 的基础包打包成单一组件接口。"],["pre",{lang:"go",highlighted:'<span class="token keyword">type</span> Service <span class="token keyword">interface</span> <span class="token punctuation">{</span>\n    <span class="token function">Init</span><span class="token punctuation">(</span><span class="token operator">...</span>Option<span class="token punctuation">)</span>\n    <span class="token function">Options</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Options\n    <span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> client<span class="token punctuation">.</span>Client\n    <span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> server<span class="token punctuation">.</span>Server\n    <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>\n    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>\n<span class="token punctuation">}</span>'},["code","type Service interface {\n    Init(...Option)\n    Options() Options\n    Client() client.Client\n    Server() server.Server\n    Run() error\n    String() string\n}"]],["h3","1. 初始化"],["p","可以使用",["code","micro.NewService"],"创建服务"],["pre",{lang:"go",highlighted:'<span class="token keyword">import</span> <span class="token string">"github.com/micro/go-micro/v2"</span>\n\nservice <span class="token operator">:=</span> micro<span class="token punctuation">.</span><span class="token function">NewService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>'},["code",'import "github.com/micro/go-micro/v2"\n\nservice := micro.NewService()']],["p","初始化时，也可以传入相关选项"],["pre",{lang:"go",highlighted:'service <span class="token operator">:=</span> micro<span class="token punctuation">.</span><span class="token function">NewService</span><span class="token punctuation">(</span>\n        micro<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token string">"greeter"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        micro<span class="token punctuation">.</span><span class="token function">Version</span><span class="token punctuation">(</span><span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span>'},["code",'service := micro.NewService(\n        micro.Name("greeter"),\n        micro.Version("latest"),\n)']],["p","所有的可选参数参考：",["a",{title:null,href:"https://pkg.go.dev/github.com/micro/go-micro/v2#Option"},"配置项"]],["p","Go Micro 也提供通过命令行参数",["code","micro.Flags"],"传递配置参数："],["pre",{lang:"go",highlighted:'<span class="token keyword">import</span> <span class="token punctuation">(</span>\n        <span class="token string">"github.com/micro/cli"</span>\n        <span class="token string">"github.com/micro/go-micro/v2"</span>\n<span class="token punctuation">)</span>\n\nservice <span class="token operator">:=</span> micro<span class="token punctuation">.</span><span class="token function">NewService</span><span class="token punctuation">(</span>\n        micro<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span>\n                cli<span class="token punctuation">.</span>StringFlag<span class="token punctuation">{</span>\n                        Name<span class="token punctuation">:</span>  <span class="token string">"environment"</span><span class="token punctuation">,</span>\n                        Usage<span class="token punctuation">:</span> <span class="token string">"The environment"</span><span class="token punctuation">,</span>\n                <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span>\n<span class="token punctuation">)</span>'},["code",'import (\n        "github.com/micro/cli"\n        "github.com/micro/go-micro/v2"\n)\n\nservice := micro.NewService(\n        micro.Flags(\n                cli.StringFlag{\n                        Name:  "environment",\n                        Usage: "The environment",\n                },\n        )\n)']],["p","解析命令行标识参数可以使用",["code","service.Init"],"，增加标识参数可以使用",["code","micro.Action"],"选项："],["pre",{lang:"go",highlighted:'service<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>\n        micro<span class="token punctuation">.</span><span class="token function">Action</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                env <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">StringFlag</span><span class="token punctuation">(</span><span class="token string">"environment"</span><span class="token punctuation">)</span>\n                <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>\n                        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Environment set to"</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span>\n                <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span>'},["code",'service.Init(\n        micro.Action(func(c *cli.Context) {\n                env := c.StringFlag("environment")\n                if len(env) > 0 {\n                        fmt.Println("Environment set to", env)\n                }\n        }),\n)']],["p","Go Micro 提供预置的标识，",["code","service.Init"],"执行时就会设置并解析这些参数。所有的标识",["a",{title:null,href:"https://pkg.go.dev/github.com/micro/go-micro/v2/cmd#pkg-variables"},"参考"],"."],["h3","2. 定义 API"],["p","我们使用 protobuf 文件来定义服务的 API 接口。使用 protobuf 可以非常方便去严格定义 API，提供服务端与客户端双边具体一致的类型。"],["p","下面是定义的示例"],["p","greeter.proto"],["pre",{lang:"proto",highlighted:'syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token comment" spellcheck="true">;</span>\n\nservice Greeter {\n\trpc <span class="token function">Hello</span><span class="token punctuation">(</span>HelloRequest<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>HelloResponse<span class="token punctuation">)</span> {}\n}\n\nmessage HelloRequest {\n\tstring name <span class="token operator">=</span> <span class="token number">1</span><span class="token comment" spellcheck="true">;</span>\n}\n\nmessage HelloResponse {\n\tstring greeting <span class="token operator">=</span> <span class="token number">2</span><span class="token comment" spellcheck="true">;</span>\n}'},["code",'syntax = "proto3";\n\nservice Greeter {\n\trpc Hello(HelloRequest) returns (HelloResponse) {}\n}\n\nmessage HelloRequest {\n\tstring name = 1;\n}\n\nmessage HelloResponse {\n\tstring greeting = 2;\n}']],["p","我们定义了一个服务叫做 Greeter 的处理器，它有一个接收 HelloRequest 并返回 HelloResponse 的 Hello 方法。"],["h3","3. 生成 API 接口"],["p","我们需要下面这个工具来生成 protobuf 代码文件，它们负责生成定义的 go 代码实现。"],["ul",["li",["p",["a",{title:null,href:"https://github.com/google/protobuf"},"protoc"]]],["li",["p",["a",{title:null,href:"https://github.com/golang/protobuf"},"protoc-gen-go"]]],["li",["p",["a",{title:null,href:"https://github.com/micro/protoc-gen-micro"},"protoc-gen-micro"]]]],["pre",{lang:"shell",highlighted:'go get github<span class="token punctuation">.</span>com<span class="token operator">/</span>golang<span class="token operator">/</span>protobuf<span class="token operator">/</span>{proto<span class="token punctuation">,</span>protoc<span class="token operator">-</span>gen<span class="token operator">-</span>go}'},["code","go get github.com/golang/protobuf/{proto,protoc-gen-go}"]],["pre",{lang:"shell",highlighted:'go get github<span class="token punctuation">.</span>com<span class="token operator">/</span>micro<span class="token operator">/</span>protoc<span class="token operator">-</span>gen<span class="token operator">-</span>micro'},["code","go get github.com/micro/protoc-gen-micro"]],["pre",{lang:null,highlighted:'protoc <span class="token operator">-</span><span class="token operator">-</span>proto_path<span class="token operator">=</span><span class="token variable">$GOPATH</span><span class="token operator">/</span>src<span class="token punctuation">:</span><span class="token punctuation">.</span> <span class="token operator">-</span><span class="token operator">-</span>micro_out<span class="token operator">=</span><span class="token punctuation">.</span> <span class="token operator">-</span><span class="token operator">-</span>go_out<span class="token operator">=</span><span class="token punctuation">.</span> greeter<span class="token punctuation">.</span>proto'},["code","protoc --proto_path=$GOPATH/src:. --micro_out=. --go_out=. greeter.proto"]],["p","生成的类现在可以引入",["strong","handler"],"中，在服务或客户端来创建请求了。"],["p","下面是部分生成的代码"],["pre",{lang:"go",highlighted:'<span class="token keyword">type</span> HelloRequest <span class="token keyword">struct</span> <span class="token punctuation">{</span>\n\tName <span class="token builtin">string</span> <span class="token string">`protobuf:"bytes,1,opt,name=name" json:"name,omitempty"`</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> HelloResponse <span class="token keyword">struct</span> <span class="token punctuation">{</span>\n\tGreeting <span class="token builtin">string</span> <span class="token string">`protobuf:"bytes,2,opt,name=greeting" json:"greeting,omitempty"`</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment" spellcheck="true">// Greeter service 客户端的API</span>\n\n<span class="token keyword">type</span> GreeterClient <span class="token keyword">interface</span> <span class="token punctuation">{</span>\n\t<span class="token function">Hello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>HelloRequest<span class="token punctuation">,</span> opts <span class="token operator">...</span>client<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>HelloResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">type</span> greeterClient <span class="token keyword">struct</span> <span class="token punctuation">{</span>\n\tc           client<span class="token punctuation">.</span>Client\n\tserviceName <span class="token builtin">string</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">func</span> <span class="token function">NewGreeterClient</span><span class="token punctuation">(</span>serviceName <span class="token builtin">string</span><span class="token punctuation">,</span> c client<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> GreeterClient <span class="token punctuation">{</span>\n\t<span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>\n\t\tc <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\t<span class="token punctuation">}</span>\n\t<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>\n\t\tserviceName <span class="token operator">=</span> <span class="token string">"greeter"</span>\n\t<span class="token punctuation">}</span>\n\t<span class="token keyword">return</span> <span class="token operator">&amp;</span>greeterClient<span class="token punctuation">{</span>\n\t\tc<span class="token punctuation">:</span>           c<span class="token punctuation">,</span>\n\t\tserviceName<span class="token punctuation">:</span> serviceName<span class="token punctuation">,</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>greeterClient<span class="token punctuation">)</span> <span class="token function">Hello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> in <span class="token operator">*</span>HelloRequest<span class="token punctuation">,</span> opts <span class="token operator">...</span>client<span class="token punctuation">.</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>HelloResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\treq <span class="token operator">:=</span> c<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>serviceName<span class="token punctuation">,</span> <span class="token string">"Greeter.Hello"</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>\n\tout <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>HelloResponse<span class="token punctuation">)</span>\n\terr <span class="token operator">:=</span> c<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">,</span> out<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>\n\t<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>\n\t\t<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err\n\t<span class="token punctuation">}</span>\n\t<span class="token keyword">return</span> out<span class="token punctuation">,</span> <span class="token boolean">nil</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment" spellcheck="true">// Greeter service 服务端</span>\n\n<span class="token keyword">type</span> GreeterHandler <span class="token keyword">interface</span> <span class="token punctuation">{</span>\n\t<span class="token function">Hello</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>HelloRequest<span class="token punctuation">,</span> <span class="token operator">*</span>HelloResponse<span class="token punctuation">)</span> <span class="token builtin">error</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">func</span> <span class="token function">RegisterGreeterHandler</span><span class="token punctuation">(</span>s server<span class="token punctuation">.</span>Server<span class="token punctuation">,</span> hdlr GreeterHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\ts<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">NewHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Greeter<span class="token punctuation">{</span>hdlr<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span>'},["code",'type HelloRequest struct {\n\tName string `protobuf:"bytes,1,opt,name=name" json:"name,omitempty"`\n}\n\ntype HelloResponse struct {\n\tGreeting string `protobuf:"bytes,2,opt,name=greeting" json:"greeting,omitempty"`\n}\n\n// Greeter service 客户端的API\n\ntype GreeterClient interface {\n\tHello(ctx context.Context, in *HelloRequest, opts ...client.CallOption) (*HelloResponse, error)\n}\n\ntype greeterClient struct {\n\tc           client.Client\n\tserviceName string\n}\n\nfunc NewGreeterClient(serviceName string, c client.Client) GreeterClient {\n\tif c == nil {\n\t\tc = client.NewClient()\n\t}\n\tif len(serviceName) == 0 {\n\t\tserviceName = "greeter"\n\t}\n\treturn &greeterClient{\n\t\tc:           c,\n\t\tserviceName: serviceName,\n\t}\n}\n\nfunc (c *greeterClient) Hello(ctx context.Context, in *HelloRequest, opts ...client.CallOption) (*HelloResponse, error) {\n\treq := c.c.NewRequest(c.serviceName, "Greeter.Hello", in)\n\tout := new(HelloResponse)\n\terr := c.c.Call(ctx, req, out, opts...)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\treturn out, nil\n}\n\n// Greeter service 服务端\n\ntype GreeterHandler interface {\n\tHello(context.Context, *HelloRequest, *HelloResponse) error\n}\n\nfunc RegisterGreeterHandler(s server.Server, hdlr GreeterHandler) {\n\ts.Handle(s.NewHandler(&Greeter{hdlr}))\n}']],["h3","4. 实现 handler 处理器"],["p","服务端需要注册",["strong","handlers"],"，这样才能提供服务并接收请求。处理器相当于是一个拥有公共方法的公共类，它需要符合签名",["code","func(ctx context.Context, req interface{}, rsp interface{}) error"]],["p","通过上面的内容，我们看到，Greeter interface 的签名的看上去就是这样："],["pre",{lang:"go",highlighted:'<span class="token keyword">type</span> GreeterHandler <span class="token keyword">interface</span> <span class="token punctuation">{</span>\n        <span class="token function">Hello</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>HelloRequest<span class="token punctuation">,</span> <span class="token operator">*</span>HelloResponse<span class="token punctuation">)</span> <span class="token builtin">error</span>\n<span class="token punctuation">}</span>'},["code","type GreeterHandler interface {\n        Hello(context.Context, *HelloRequest, *HelloResponse) error\n}"]],["p","Greeter 处理器实现："],["pre",{lang:"go",highlighted:'<span class="token keyword">import</span> proto <span class="token string">"github.com/micro/examples/service/proto"</span>\n\n<span class="token keyword">type</span> Greeter <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>Greeter<span class="token punctuation">)</span> <span class="token function">Hello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>proto<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">,</span> rsp <span class="token operator">*</span>proto<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>\n\trsp<span class="token punctuation">.</span>Greeting <span class="token operator">=</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>Name\n\t<span class="token keyword">return</span> <span class="token boolean">nil</span>\n<span class="token punctuation">}</span>'},["code",'import proto "github.com/micro/examples/service/proto"\n\ntype Greeter struct{}\n\nfunc (g *Greeter) Hello(ctx context.Context, req *proto.HelloRequest, rsp *proto.HelloResponse) error {\n\trsp.Greeting = "Hello " + req.Name\n\treturn nil\n}']],["p","处理器会与服务一起被注册，就像 http 处理器一样。"],["pre",{lang:null,highlighted:'service <span class="token punctuation">:</span><span class="token operator">=</span> micro<span class="token punctuation">.</span><span class="token function">NewService</span><span class="token punctuation">(</span>\n\tmicro<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token string">"greeter"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n<span class="token punctuation">)</span>\n\nproto<span class="token punctuation">.</span><span class="token function">RegisterGreeterHandler</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>Greeter<span class="token punctuation">)</span><span class="token punctuation">)</span>'},["code",'service := micro.NewService(\n\tmicro.Name("greeter"),\n)\n\nproto.RegisterGreeterHandler(service.Server(), new(Greeter))']],["h3","5. 运行服务"],["p","服务可以调用",["code","server.Run"],"运行起来。这一步会让服务绑到配置中的地址（默认遵循 RFC1918，分配随机的端口）接收请求。"],["p","另外，这一步会在服务启动时向注册中心",["code","注册"],"，并在服务接收到关闭信号时",["code","卸载"],"。"],["pre",{lang:"go",highlighted:'<span class="token keyword">if</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>\n\tlog<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>\n<span class="token punctuation">}</span>'},["code","if err := service.Run(); err != nil {\n\tlog.Fatal(err)\n}"]],["h3","6. 完整的服务代码"],["p",["br"],"\ngreeter.go"],["pre",{lang:"go",highlighted:'<span class="token keyword">package</span> main\n\n<span class="token keyword">import</span> <span class="token punctuation">(</span>\n        <span class="token string">"log"</span>\n\n        <span class="token string">"github.com/micro/go-micro/v2"</span>\n        proto <span class="token string">"github.com/micro/examples/service/proto"</span>\n\n        <span class="token string">"golang.org/x/net/context"</span>\n<span class="token punctuation">)</span>\n\n<span class="token keyword">type</span> Greeter <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>\n\n<span class="token keyword">func</span> <span class="token punctuation">(</span>g <span class="token operator">*</span>Greeter<span class="token punctuation">)</span> <span class="token function">Hello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>proto<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">,</span> rsp <span class="token operator">*</span>proto<span class="token punctuation">.</span>HelloResponse<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>\n        rsp<span class="token punctuation">.</span>Greeting <span class="token operator">=</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>Name\n        <span class="token keyword">return</span> <span class="token boolean">nil</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        service <span class="token operator">:=</span> micro<span class="token punctuation">.</span><span class="token function">NewService</span><span class="token punctuation">(</span>\n                micro<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token string">"greeter"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                micro<span class="token punctuation">.</span><span class="token function">Version</span><span class="token punctuation">(</span><span class="token string">"latest"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token punctuation">)</span>\n\n        service<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n        proto<span class="token punctuation">.</span><span class="token function">RegisterGreeterHandler</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>Greeter<span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n        <span class="token keyword">if</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>\n                log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>\n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>'},["code",'package main\n\nimport (\n        "log"\n\n        "github.com/micro/go-micro/v2"\n        proto "github.com/micro/examples/service/proto"\n\n        "golang.org/x/net/context"\n)\n\ntype Greeter struct{}\n\nfunc (g *Greeter) Hello(ctx context.Context, req *proto.HelloRequest, rsp *proto.HelloResponse) error {\n        rsp.Greeting = "Hello " + req.Name\n        return nil\n}\n\nfunc main() {\n        service := micro.NewService(\n                micro.Name("greeter"),\n                micro.Version("latest"),\n        )\n\n        service.Init()\n\n        proto.RegisterGreeterHandler(service.Server(), new(Greeter))\n\n        if err := service.Run(); err != nil {\n                log.Fatal(err)\n        }\n}']],["p","需要注意的是，要保证服务发现机制运行起来，这样服务才能注册，其它服务或客户端才能发现它。快速启动可",["a",{title:null,href:"https://github.com/micro/go-micro#getting-started"},"参考"],"。"],["h2","编写客户端"],["p",["a",{title:null,href:"https://pkg.go.dev/github.com/micro/go-micro/v2/client"},"客户端"],"包用于查询服务，当创建服务时，也包含了一个客户端，这个客户端匹配服务所使用的初始化包。"],["p","查询上面的服务很简单："],["pre",{lang:"go",highlighted:'<span class="token comment" spellcheck="true">// 创建greate客户端，这需要传入服务名与服务的客户端方法构建的客户端对象</span>\ngreeter <span class="token operator">:=</span> proto<span class="token punctuation">.</span><span class="token function">NewGreeterClient</span><span class="token punctuation">(</span><span class="token string">"greeter"</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token comment" spellcheck="true">// 在Greeter handler上请求调用Hello方法</span>\nrsp<span class="token punctuation">,</span> err <span class="token operator">:=</span> greeter<span class="token punctuation">.</span><span class="token function">Hello</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>proto<span class="token punctuation">.</span>HelloRequest<span class="token punctuation">{</span>\n\tName<span class="token punctuation">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>\n\tfmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>\n\t<span class="token keyword">return</span>\n<span class="token punctuation">}</span>\n\nfmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span>Greeter<span class="token punctuation">)</span>'},["code",'// 创建greate客户端，这需要传入服务名与服务的客户端方法构建的客户端对象\ngreeter := proto.NewGreeterClient("greeter", service.Client())\n\n// 在Greeter handler上请求调用Hello方法\nrsp, err := greeter.Hello(context.TODO(), &proto.HelloRequest{\n\tName: "John",\n})\nif err != nil {\n\tfmt.Println(err)\n\treturn\n}\n\nfmt.Println(rsp.Greeter)']],["p",["code","proto.NewGreeterClient"]," 需要服务名与客户端来请求服务。"],["p","完整示例参考：",["a",{title:null,href:"https://github.com/micro/examples/tree/master/service"},"go-micro/examples/service"],"."]],meta:{order:33,title:"编写Golang服务",filename:"docs/stack-rpc/writing-a-go-service.zh-CN.md"},toc:["ul",["li",["a",{className:"bisheng-toc-h2",href:"#编写服务",title:"编写服务"},"编写服务"]],["li",["a",{className:"bisheng-toc-h2",href:"#编写客户端",title:"编写客户端"},"编写客户端"]]]}}}]);